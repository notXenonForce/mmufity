{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Streaming Service</title>
    <link rel="stylesheet" type="text/css" href="{% static 'style.css' %}" />
</head>
<body style="margin:0; padding:0; background:#121212; font-family:Arial, sans-serif; color:#fff;">
    <!-- Sidebar remains unchanged -->
    <div class="sidebar">
        <!-- Spotify Logo -->
        <div class="logo-container">
            <img src="{% static 'Images\logo.png' %}" style="width: 100%; height: auto; padding: 20px; box-sizing: border-box;">
        </div>

        <!-- Top section of the sidebar -->
        <div class="sidebar-section">
            <a href="#" class="sidebar-link active">
                <span class="sidebar-link-icon">üè†</span>
                Home
            </a>
            <a href="#" class="sidebar-link">
                <span class="sidebar-link-icon">üîç</span>
                Search
            </a>
            <a href="#" class="sidebar-link">
                <span class="sidebar-link-icon">üéµ</span>
                Your Library
            </a>
        </div>

        <!-- Bottom section of the sidebar -->
        <div class="sidebar-section">
            <a href="#" class="sidebar-link active">
                <span class="sidebar-link-icon">üíú</span>
                <span class="sidebar-link-text">Liked Songs</span>
            </a>
            <!-- Repeat for each item -->
            <a href="#" class="sidebar-link">
                <span class="sidebar-link-icon">üé∂</span>
                <span class="sidebar-link-text">K-Pop</span>
            </a>
            <a href="#" class="sidebar-link">
                <span class="sidebar-link-icon">üë§</span>
                <span class="sidebar-link-text">YOASOBI</span>
            </a>
            <!-- ... more links ... -->
        </div>
    </div>
    <!-- Main content area where we will add the music player -->
    <div class="music-player" style="margin-left:240px; padding:20px; display: flex; justify-content: center; align-items: center; height: calc(100vh - 90px);">
        <!-- Music Player Interface -->
        <div class="player-container">
            {% if album and album.cover_image %}
            <img class="album-cover" src="{{ album.cover_image.url }}" alt="Album Cover" style="padding-top: 100px">
            {% else %}
            <img class="album-cover" src="{% static 'Images/IUlogo.jpg' %}" alt="Album Cover" style="padding-top: 100px">
            {% endif %}
            <div class="song-info">
                <h1 class="song-title">{% if selected_track %}{{ selected_track.music_name }}{% else %}{% if album %}{{album.name}}{% else %}No Album Selected{% endif %}{% endif %}</h1>
                <h2 class="artist-name" style="font-size: 0.9rem;">{% if selected_track and selected_track.artist %}{{ selected_track.artist.user.username }}{% elif tracks|length > 0 and tracks.0.artist %}{{ tracks.0.artist.user.username }}{% else %}Unknown Artist{% endif %}</h2>
            </div>
            <div class="player-controls">
                <button id="prev" class="control-btn">‚óÑ</button>
                <button id="play-pause" class="control-btn play-btn" style="color: rgb(29 91 185)">‚ñ∫</button>
                <button id="next" class="control-btn">‚ñ∫</button>
            </div>
            <div class="progress-bar" id="progress-bar">
                <div class="progress" id="progress" style="color: rgb(29 91 185)"></div>
            </div>
            <div class="time-stamps">
                <span id="current-time">0:00</span>
                <span id="total-duration">4:00</span>
            </div>
            <div class = "song_list">
                {% if tracks %}
                  <ul>
                    {% for track in tracks %}
                      <li class="track {% if track == selected_track %}selected{% endif %}" data-src="{{ track.audio_file.url }}" data-index="{{ forloop.counter0 }}">{{ track.music_name }}</li>
                    {% endfor %}
                  </ul>
                {% endif %}
            </div>
        </div>

        <audio id="audio-player" src="{% if selected_track %}{{ selected_track.audio_file.url }}{% endif %}"></audio>
    </div>

    <script>
        const audioPlayer = document.getElementById('audio-player');
        const playPauseBtn = document.getElementById('play-pause');
        const trackList = document.querySelectorAll('.track');
        let currentTrackIndex = 0;

        function loadTrack(index) {
            // Remove 'selected' class from previously selected track
            const previouslySelected = document.querySelector('.track.selected');
            if (previouslySelected) {
                previouslySelected.classList.remove('selected');
            }

            const trackElement = trackList[index];
            const trackSrc = trackElement.getAttribute('data-src');

            audioPlayer.src = trackSrc;
            audioPlayer.load();
            audioPlayer.play(); // ADDED autoplay
            playPauseBtn.textContent = '‚è∏';
            // Add 'selected' class to the newly selected track
            trackElement.classList.add('selected');

            // Update displayed song information
            updateDisplay(trackElement);
        }

        function updateDisplay(trackElement) {
            const trackSrc = trackElement.getAttribute('data-src');
            const trackName = trackElement.textContent;

            document.querySelector('.song-title').textContent = trackName;

            audioPlayer.src = trackSrc;
            audioPlayer.load();
        }

        // Load selected song or first song on page load
        {% if selected_track %}
        const selectedTrackElement = document.querySelector('.track.selected');
        if (selectedTrackElement) {
            let foundIndex = Array.from(trackList).findIndex(el => el === selectedTrackElement);
            if(foundIndex !== -1) {
                currentTrackIndex = foundIndex;
            }
            const selectedTrackSrc = selectedTrackElement.getAttribute('data-src');
            audioPlayer.src = selectedTrackSrc;
            audioPlayer.load();
             if(!audioPlayer.paused){
                playPauseBtn.textContent = '‚è∏';
             }
        }
        {% endif %}

        playPauseBtn.addEventListener('click', () => {
            if (audioPlayer.paused) {
                audioPlayer.play();
                playPauseBtn.textContent = '‚è∏';
            } else {
                audioPlayer.pause();
                playPauseBtn.textContent = '‚ñ∂';
            }
        });

        // Event Listeners for track list
        trackList.forEach((track, index) => {
            track.addEventListener('click', () => {
                currentTrackIndex = index;
                loadTrack(currentTrackIndex);
                audioPlayer.play();
                playPauseBtn.textContent = '‚è∏';
            });
        });

        // Track NAVIGATION
        function trackNext() {
            if (!trackList || trackList.length === 0) return; // Safety check

            currentTrackIndex++;
            if (currentTrackIndex >= trackList.length) {
                currentTrackIndex = 0;
            }
            loadTrack(currentTrackIndex);
            audioPlayer.play();
            playPauseBtn.textContent = '‚è∏';
        }

        function trackPrevious() {
            if (!trackList || trackList.length === 0) return; // Safety check

            currentTrackIndex--;
            if (currentTrackIndex < 0) {
                currentTrackIndex = trackList.length - 1;
            }
            loadTrack(currentTrackIndex);
            audioPlayer.play();
            playPauseBtn.textContent = '‚è∏';
        }

        document.getElementById('next').addEventListener('click', () => {
            trackNext();
        });

        document.getElementById('prev').addEventListener('click', () => {
            trackPrevious();
        });

        audioPlayer.addEventListener('ended', () => {
            trackNext();
        });


    </script>
</body>
</html>