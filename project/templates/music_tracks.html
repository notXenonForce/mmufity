{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Streaming Service</title>
    <link rel="stylesheet" type="text/css" href="{% static 'style.css' %}" />
</head>
<body style="margin:0; padding:0; background:#121212; font-family:Arial, sans-serif; color:#fff;">
    <!-- Sidebar remains unchanged -->
    <div class="sidebar">
        <!-- Spotify Logo -->
        <div class="logo-container">
            <img src="{% static 'Images/logo.png' %}" style="width: 100%; height: auto; padding: 20px; box-sizing: border-box;">
        </div>

        <!-- Top section of the sidebar -->
        <div class="sidebar-section">
            <a href="#" class="sidebar-link active">
                <span class="sidebar-link-icon">üè†</span>
                Home
            </a>
            <a href="#" class="sidebar-link">
                <span class="sidebar-link-icon">üîç</span>
                Search
            </a>
            <a href="#" class="sidebar-link">
                <span class="sidebar-link-icon">üéµ</span>
                Your Library
            </a>
        </div>

        <!-- Bottom section of the sidebar -->
        <div class="sidebar-section">
            <a href="#" class="sidebar-link active">
                <span class="sidebar-link-icon">üíú</span>
                <span class="sidebar-link-text">Liked Songs</span>
            </a>
            <!-- Repeat for each item -->
            <a href="#" class="sidebar-link">
                <span class="sidebar-link-icon">üé∂</span>
                <span class="sidebar-link-text">K-Pop</span>
            </a>
            <a href="#" class="sidebar-link">
                <span class="sidebar-link-icon">üë§</span>
                <span class="sidebar-link-text">YOASOBI</span>
            </a>
            <!-- ... more links ... -->
        </div>
    </div>
    <!-- Main content area where we will add the music player -->
    <div class="music-player" style="margin-left:240px; padding:20px; display: flex; justify-content: center; align-items: center; height: calc(100vh - 90px);">
        <!-- Music Player Interface -->
        <div class="player-container">
            {% if album and album.cover_image %}
            <img class="album-cover" src="{{ album.cover_image.url }}" alt="Album Cover" style="padding-top: 100px">
            {% else %}
            <img class="album-cover" src="{% static 'Images/IUlogo.jpg' %}" alt="Album Cover" style="padding-top: 100px">
            {% endif %}
            <div class="song-info">
                <h1 class="song-title">{% if selected_track %}{{ selected_track.music_name }}{% else %}{% if album %}{{album.name}}{% else %}No Album Selected{% endif %}{% endif %}</h1>
                <h2 class="artist-name" style="font-size: 0.9rem;">{% if selected_track and selected_track.artist %}{{ selected_track.artist.user.username }}{% elif tracks|length > 0 and tracks.0.artist %}{{ tracks.0.artist.user.username }}{% else %}Unknown Artist{% endif %}</h2>
            </div>
            <div class="player-controls">
                <button id="prev" class="control-btn">‚óÑ</button>
                <button id="play-pause" class="control-btn play-btn" style="color: rgb(29 91 185)">‚ñ∫</button>
                <button id="next" class="control-btn">‚ñ∫</button>
            </div>
            <div class="progress-bar" id="progress-bar">
                <div class="progress" id="progress" style="color: rgb(29 91 185)"></div>
            </div>
            <div class="time-stamps">
                <span id="current-time">0:00</span>
                <span id="total-duration">4:00</span>
            </div>
        </div>

        <audio id="audio-player" src="{% if selected_track %}{{ selected_track.audio_file.url }}{% endif %}"></audio>
    </div>

    <script>
        const audioPlayer = document.getElementById('audio-player');
        const playPauseBtn = document.getElementById('play-pause');

        playPauseBtn.addEventListener('click', () => {
            if (audioPlayer.paused) {
                audioPlayer.play();
                playPauseBtn.textContent = '‚è∏';
            } else {
                audioPlayer.pause();
                playPauseBtn.textContent = '‚ñ∂';
            }
        });
      </script>
    <script>
// Load selected song or first song on page load

const nextButton = document.getElementById('next');
const prevButton = document.getElementById('prev');

function navigateToTrack(trackId) {
fetch(`/tracks/?track_id=${trackId}`)
  .then(response => {
    if (response.ok) {
      // If the track exists (response is OK), navigate to it
      window.location.href = `/tracks/?track_id=${trackId}`;
    } else if (response.status === 404) {
      // If the track doesn't exist (404 error), navigate back to track 1
      window.location.href = `/tracks/?track_id=1`;
    } else {
      // Handle other errors (e.g., 500 server error)
      console.error("Error navigating to track:", response.status);
      // Optionally, display an error message to the user
      alert("An error occurred while trying to play the track. Please try again.");
    }
  })
  .catch(error => {
    // Handle network errors
    console.error("Network error:", error);
    // Optionally, display an error message to the user
    alert("A network error occurred. Please check your internet connection and try again.");
  });
}


function updateDisplay(direction) {
let trackId = parseInt("{{selected_track.id}}");
const maxTrackId = parseInt("{{ max_track_id }}"); // Get the maximum track ID from the template
 const firstTrackId = parseInt("{{ first_track_id }}"); // Get the *first* track ID from the template


if (direction == "Next"){
  let nextTrackId = trackId + 1;
  if (nextTrackId > maxTrackId) {
    nextTrackId = firstTrackId; // Instead of 1, use firstTrackId
  }
  navigateToTrack(nextTrackId); // Use navigateToTrack function

}
else{
    if (trackId > 1) { // Only go to previous if trackId is greater than 1
       let prevTrackId = trackId - 1;
       navigateToTrack(prevTrackId); // Use navigateToTrack function
    }
}
};

document.getElementById('next').addEventListener('click', function(){updateDisplay("Next")})
document.getElementById('prev').addEventListener('click', function(){updateDisplay("Previous")})

    </script>
        {% if messages %}
    <ul class="messages">
        {% for message in messages %}
        <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
</body>
</html>